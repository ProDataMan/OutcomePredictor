name: ðŸ¦ˆ Deploy StatShark to Azure

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch: # Allow manual triggers

env:
  AZURE_RESOURCE_GROUP: 'ProDataMan'
  AZURE_REGISTRY_RESOURCE_GROUP: 'statshark-rg'
  AZURE_CONTAINER_REGISTRY: 'statsharkregistry'
  AZURE_APP_SERVICE_PLAN: 'ASP-ProDataMan-996c'
  AZURE_WEBAPP_NAME: 'statshark-api'
  IMAGE_NAME: 'statshark-server'

jobs:
  build-and-test:
    name: ðŸ§ª Build and Test
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ§ Set up Swift
      uses: swift-actions/setup-swift@v2
      with:
        swift-version: '6.2'

    - name: ðŸ“¦ Cache Swift packages
      uses: actions/cache@v4
      with:
        path: .build
        key: ${{ runner.os }}-swift-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-swift-

    - name: ðŸ”¨ Build project
      run: swift build --configuration release --product nfl-server

    - name: ðŸ§ª Run tests
      run: swift test --no-parallel --configuration release

    - name: ðŸ“Š Generate test report
      if: always()
      run: |
        echo "Tests completed with exit code: $?"
        echo "Build artifacts:"
        ls -la .build/release/ || echo "No release build artifacts found"

  deploy-to-azure:
    name: ðŸš€ Deploy to Azure
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    environment: production

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ” Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ”‘ Login to Azure Container Registry
      uses: azure/docker-login@v2
      with:
        login-server: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io
        username: ${{ env.AZURE_CONTAINER_REGISTRY }}
        password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}

    - name: ðŸ—ï¸ Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        cache-from: type=registry,ref=${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache
        cache-to: type=registry,ref=${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache,mode=max
        platforms: linux/amd64

    - name: ðŸŽ¯ Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        images: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}

    - name: âš™ï¸ Configure App Settings
      uses: azure/appservice-settings@v1
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        app-settings-json: |
          [
            {
              "name": "ENV",
              "value": "production"
            },
            {
              "name": "PORT",
              "value": "8080"
            },
            {
              "name": "WEBSITES_PORT",
              "value": "8080"
            },
            {
              "name": "ODDS_API_KEY",
              "value": "${{ secrets.ODDS_API_KEY }}"
            },
            {
              "name": "ESPN_BASE_URL",
              "value": "https://site.api.espn.com/apis/site/v2/sports/football/nfl"
            },
            {
              "name": "ODDS_API_BASE_URL",
              "value": "https://api.the-odds-api.com/v4"
            },
            {
              "name": "SERVER_BASE_URL",
              "value": "https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/v1"
            },
            {
              "name": "CACHE_EXPIRATION",
              "value": "21600"
            }
          ]

    - name: ðŸ”„ Restart App Service
      run: |
        az webapp restart \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_WEBAPP_NAME }}

    - name: â³ Wait for deployment
      run: sleep 30

    - name: ðŸ§ª Test deployment
      run: |
        echo "Testing deployment..."
        APP_URL="https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"

        echo "Testing /api/v1/teams endpoint..."
        if curl -sf "$APP_URL/api/v1/teams" > /dev/null; then
          echo "âœ… API is responding!"
        else
          echo "âš ï¸ API not responding yet. Checking logs..."
          az webapp log download \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --log-file deployment-logs.zip
          exit 1
        fi

        echo "ðŸŽ‰ Deployment successful!"
        echo "API URL: $APP_URL/api/v1"

  notify-deployment:
    name: ðŸ“¢ Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy-to-azure]
    if: always()

    steps:
    - name: ðŸ“Š Deployment Summary
      run: |
        echo "## ðŸ¦ˆ StatShark Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Status:** ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "**Deploy Status:** ${{ needs.deploy-to-azure.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.deploy-to-azure.result }}" = "success" ]; then
          echo "âœ… **Deployment successful!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **API URL:** https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/v1" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Endpoints:**" >> $GITHUB_STEP_SUMMARY
          echo "- Teams: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/v1/teams" >> $GITHUB_STEP_SUMMARY
          echo "- Upcoming: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/v1/upcoming" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Deployment failed!**" >> $GITHUB_STEP_SUMMARY
        fi